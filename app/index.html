<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Brikk – Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root { color-scheme: dark; }
    body { margin:0; font:16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, sans-serif; background:#0b0f1a; color:#e7ecff; }
    header { padding:16px 24px; border-bottom:1px solid #1c2541; display:flex; gap:16px; align-items:center; }
    header .spacer { flex:1 }
    main { padding:24px; max-width:1100px; margin:auto; }
    .grid { display:grid; grid-template-columns:1fr 1fr; gap:16px; }
    .card { background:#0f1629; border:1px solid #1c2541; border-radius:16px; padding:18px; }
    .muted { color:#98b0d9 }
    button { background:#635bff; color:#fff; border:none; padding:.6rem 1rem; border-radius:10px; font-weight:600; cursor:pointer; }
    button.secondary { background:#142042; }
    input, textarea, select { width:100%; background:#0B1222; border:1px solid #2a3450; color:#e7ecff; border-radius:10px; padding:.7rem .8rem; }
    label { display:block; font-weight:600; margin:8px 0 6px; }
    pre { white-space:pre-wrap; }
    @media (max-width:900px) { .grid { grid-template-columns:1fr; } }
  </style>
</head>
<body>
  <header>
    <strong>Brikk</strong>
    <span class="muted">/ Dashboard</span>
    <div class="spacer"></div>
    <button id="logout" class="secondary">Logout</button>
  </header>

  <main>
    <div id="auth" class="card">Checking your session…</div>

    <div id="content" style="display:none">
      <div id="verifyBanner" class="card" style="display:none; margin-bottom:16px">
        <strong>Email verification pending</strong>
        <div class="muted" style="margin-top:6px">Please check your inbox for a verification email.</div>
        <div style="margin-top:10px;"><button id="resendVerify" class="secondary">Resend verification email</button></div>
      </div>

      <div class="grid">
        <div class="card">
          <h2>Welcome, <span id="name">—</span></h2>
          <div class="muted">
            Email: <span id="email">—</span>
            <span id="order" style="margin-left:12px"></span>
          </div>
          <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap;">
            <button id="manageBilling">Manage billing</button>
            <button id="revealKey" class="secondary">Reveal API key</button>
            <span id="apiKey" class="muted" style="display:none; margin-left:8px"></span>
          </div>
        </div>

        <div class="card">
          <h3>Run a Demo Workflow</h3>
          <label for="workflow">Workflow</label>
          <select id="workflow">
            <option value="data_processing">Data Processing</option>
            <option value="financial_analysis">Financial Analysis</option>
            <option value="customer_service">Customer Service</option>
          </select>
          <div style="margin-top:10px"><button id="run">Execute</button></div>
          <pre id="result" class="muted" style="margin-top:12px"></pre>
        </div>

        <div class="card">
          <h3>Requests (last 10)</h3>
          <canvas id="reqChart" height="140"></canvas>
        </div>

        <div class="card">
          <h3>Latency (ms)</h3>
          <canvas id="latChart" height="140"></canvas>
        </div>
      </div>
    </div>
  </main>

<script>
const API = '/api';  // ← use Netlify proxy

// Helper with cookie credentials + sane error messages
async function j(url, opts = {}) {
  const r = await fetch(url, { credentials: 'include', ...opts });
  if (!r.ok) {
    const t = await r.text().catch(()=> '');
    throw new Error(t || (r.status + ''));
  }
  const ct = r.headers.get('content-type') || '';
  return ct.includes('application/json') ? r.json() : { success: true };
}

let reqChart, latChart;

async function boot() {
  try {
    const me = await j(API + '/me');

    document.getElementById('auth').style.display = 'none';
    document.getElementById('content').style.display = 'block';

    document.getElementById('name').textContent  = me.user?.username || 'User';
    document.getElementById('email').textContent = me.user?.email || '—';

    if (me.order_ref) {
      document.getElementById('order').innerHTML = `• Order Ref: <strong>${me.order_ref}</strong>`;
    }

    if (!me.email_verified) {
      document.getElementById('verifyBanner').style.display = 'block';
      document.getElementById('resendVerify').onclick = async () => {
        try {
          await j(API + '/auth/resend-verification', {
            method: 'POST',
            headers: { 'content-type': 'application/json' },
            body: JSON.stringify({ email: me.user?.email })
          });
          alert('Verification email sent.');
        } catch (e) {
          alert('Could not resend verification email.');
        }
      };
    }

    document.getElementById('run').onclick = async () => {
      const wf = document.getElementById('workflow').value;
      document.getElementById('result').textContent = 'Running…';
      try {
        const out = await j(`${API}/workflows/${encodeURIComponent(wf)}/execute`, {
          method:'POST',
          headers: { 'content-type':'application/json' },
          body: JSON.stringify({ initiator_agent_id: 'dashboard' })
        });
        document.getElementById('result').textContent = JSON.stringify(out, null, 2);
      } catch(e) {
        document.getElementById('result').textContent = 'Error: ' + e.message;
      }
    };

    document.getElementById('manageBilling').onclick = async () => {
      try {
        const r = await j('/.netlify/functions/createPortal');
        if (r.url) location.href = r.url;
      } catch(e) { alert('Could not open billing portal'); }
    };

    document.getElementById('revealKey').onclick = () => {
      const span = document.getElementById('apiKey');
      span.style.display = 'inline';
      span.textContent = '(coming soon – add /api/key to backend)';
    };

    function makeChart(ctx, label, data, color) {
      return new Chart(ctx, {
        type: 'line',
        data: {
          labels: Array.from({length: data.length}, (_,i) => i+1),
          datasets: [{ label, data, borderColor: color, fill:false, tension:.2 }]
        },
        options: { plugins:{legend:{display:false}}, scales:{x:{display:false}} }
      });
    }

    async function loadMetrics() {
      try {
        const m = await j(API + '/metrics');
        const s = m.series || { last10m: [2,3,5,4,6,7,4,6,5,8], latency: [220,210,230,190,200,240,210,220,205,215] };
        if (!reqChart) {
          reqChart = makeChart(document.getElementById('reqChart'), 'Requests', s.last10m, '#66a3ff');
          latChart = makeChart(document.getElementById('latChart'), 'Latency',  s.latency, '#9f7cff');
        } else {
          reqChart.data.datasets[0].data = s.last10m;
          latChart.data.datasets[0].data = s.latency;
          reqChart.update(); latChart.update();
        }
      } catch(e) { /* ignore */ }
    }
    loadMetrics();
    setInterval(loadMetrics, 15000);

    document.getElementById('logout').onclick = async () => {
      await j(API + '/auth/logout', { method:'POST' }).catch(()=>{});
      location.href = '/';
    };

  } catch(e) {
    document.getElementById('auth').textContent =
      'You are not signed in. Please finish email verification or log in.';
  }
}

boot();
</script>
</body>
</html>

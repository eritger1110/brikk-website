<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Brikk • You’re all set</title>
<style>
  :root { color-scheme: dark; }
  body{margin:0;background:#0b0f1a;color:#e7ecff;font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif}
  .wrap{max-width:960px;margin:48px auto;padding:0 20px}
  .panel{background:#0f1629;border:1px solid #1c2541;border-radius:16px;padding:20px}
  h1{margin:0 0 10px;font-size:28px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:18px}
  .col{background:#0f1629;border:1px solid #1c2541;border-radius:16px;padding:16px}
  label{display:block;font-weight:600;margin:8px 0 6px}
  input{width:100%;background:#0B1222;border:1px solid #2a3450;color:#e7ecff;border-radius:10px;padding:.7rem .8rem}
  button{background:#635bff;color:#fff;border:none;padding:.7rem 1rem;border-radius:10px;font-weight:600;cursor:pointer}
  button.secondary{background:#142042}
  .help{color:#98b0d9;font-size:14px}
  .error{color:#ff8f8f;margin-top:8px;font-size:14px}
  details{margin-top:10px}
  @media (max-width:900px){.row{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="wrap">
  <div class="panel">
    <h1>You’re all set 🎉</h1>
    <p>Thanks for subscribing to Brikk. We’ve emailed a receipt and account details to <strong id="emailLbl">your email</strong>.</p>

    <details>
      <summary class="help">Need to contact support? You can copy the session reference.</summary>
      <code id="sessionRef" class="help"></code>
    </details>

    <div style="margin-top:18px; display:flex; gap:8px; flex-wrap:wrap;">
      <button id="gotoHome" class="secondary">Go to Home</button>
      <button id="gotoDashboard" class="secondary">Go to Dashboard (1-click sign-in)</button>
    </div>
  </div>

  <div class="row">
    <div class="col">
      <h3>Create your account</h3>
      <div class="help">Please set your password to finish account setup.</div>
      <form id="signupForm" style="margin-top:10px">
        <div class="row" style="grid-template-columns:1fr 1fr;gap:12px">
          <div>
            <label for="first">First name</label>
            <input id="first" autocomplete="given-name" required>
          </div>
          <div>
            <label for="last">Last name</label>
            <input id="last" autocomplete="family-name" required>
          </div>
        </div>

        <label for="email">Email</label>
        <input id="email" type="email" autocomplete="email" readonly>

        <label for="pw">Password</label>
        <input id="pw" type="password" autocomplete="new-password" required>
        <div class="help">Minimum 10 chars, at least one uppercase, one lowercase, one number, one symbol.</div>

        <label for="pw2">Confirm password</label>
        <input id="pw2" type="password" autocomplete="new-password" required>

        <div class="error" id="err" style="display:none"></div>
        <div style="margin-top:12px"><button id="createBtn" type="submit">Create account</button></div>
      </form>
    </div>

    <div class="col">
      <h3>What happens next?</h3>
      <ul class="help" style="margin:0 0 0 18px; padding:0; list-style:disc">
        <li>We’ll send you a verification email (valid for 24h).</li>
        <li>After creating your account you’ll be signed in and taken to the dashboard.</li>
        <li>You can always manage billing from your dashboard.</li>
      </ul>
    </div>
  </div>
</div>

<script>
const API = 'https://api.getbrikk.com';

function qs(s){return document.querySelector(s)}
function getParam(name){
  const u = new URL(location.href);
  return u.searchParams.get(name);
}

(async function boot(){
  const sessionId = getParam('session_id') || '';
  const email = new URLSearchParams(location.search).get('customer_email') || ''; // fallback if you pass it
  qs('#sessionRef').textContent = sessionId || '(none)';
  qs('#emailLbl').textContent = email || '(your email)';
  qs('#email').value = email || '';

  // Optional “Go to dashboard” (1-click sign-in). Stays manual; no auto redirect.
  qs('#gotoDashboard').onclick = async () => {
    try {
      const r = await fetch('/.netlify/functions/provision-link?session_id=' + encodeURIComponent(sessionId), { credentials:'include' });
      const j = await r.json();
      if (j.url) location.href = j.url;
      else alert('Could not make sign-in link. Please create an account instead.');
    } catch(e){ alert('Could not reach server. Please create an account instead.'); }
  };

  qs('#gotoHome').onclick = () => { location.href = '/'; };

  // Create account flow
  qs('#signupForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    qs('#err').style.display = 'none';
    const payload = {
      first_name: qs('#first').value.trim(),
      last_name:  qs('#last').value.trim(),
      email:      qs('#email').value.trim().toLowerCase(),
      password:   qs('#pw').value,
      confirm_password: qs('#pw2').value
    };
    try {
      const res = await fetch(API + '/api/signup', {
        method:'POST',
        headers: {'content-type':'application/json'},
        credentials: 'include',
        body: JSON.stringify(payload)
      });
      const j = await res.json().catch(() => ({}));
      if (!res.ok) {
        qs('#err').textContent = j.error || 'Could not create account';
        qs('#err').style.display = 'block';
        return;
      }
      // Signed in by server -> go to dashboard
      location.href = 'https://app.getbrikk.com/';
    } catch(err){
      qs('#err').textContent = 'Network error: could not reach API';
      qs('#err').style.display = 'block';
    }
  });
})();
</script>
</body>
</html>

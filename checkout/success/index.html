<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Thanks â€” Brikk</title>
  <meta name="robots" content="noindex">
  <style>
    :root { color-scheme: dark; }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font: 16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, sans-serif;
      background:#0b0f1a; color:#e7ecff;
    }
    .wrap {
      min-height: 100svh;
      display: grid;
      place-items: center;
      padding: 24px;
    }
    .card {
      width: min(920px, 96vw);
      background: #0f1629;
      border: 1px solid #1C2541;
      border-radius: 16px;
      padding: 28px 32px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    h1 { font-size: 32px; margin: 0 0 10px; }
    .muted { color:#9fb0d9; }
    .status { display:block; margin-top:6px; color:#9fb0d9; font-size:0.95rem; }
    .btn {
      display:inline-block;
      margin-top: 18px;
      padding: .75rem 1.25rem;
      background:#635bff;
      color:#fff;
      text-decoration:none;
      border-radius:12px;
      font-weight:600;
    }
    code {
      background:#0b1222;
      padding:.12rem .35rem;
      border-radius:6px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      font-size:.9rem;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card" role="status" aria-live="polite">
      <h1>You're all set ðŸŽ‰</h1>

      <p id="msg">
        Thanks for subscribing to Brikk.
        Weâ€™ve emailed a receipt and account details
        <span id="emailWrap" class="muted" style="display:none">
          to <strong id="email"></strong>.
        </span>
      </p>

      <p class="muted">
        Session: <code id="sid">â€”</code>
        <span id="subStatus" class="status"></span>
      </p>

      <a class="btn" href="/">Go to Home</a>
    </div>
  </div>

  <script>
    (function () {
      // Parse session id from the URL (?session_id=cs_live_...)
      const qs = new URLSearchParams(location.search);
      const sid = qs.get('session_id') || qs.get('session') || '';
      document.getElementById('sid').textContent = sid || 'â€”';

      // If we don't have a session id, just show the static message
      if (!sid) return;

      // Look up the Session on our Netlify function (server side) to safely read details
      fetch('/.netlify/functions/checkout-session?session_id=' + encodeURIComponent(sid), {
        headers: { 'Accept': 'application/json' }
      })
      .then(r => r.ok ? r.json() : Promise.reject(new Error('HTTP ' + r.status)))
      .then(data => {
        // Prefer email from customer_details; fallback to customer.email when expanded
        const email =
          (data.customer_details && data.customer_details.email) ||
          (data.customer && data.customer.email) || '';

        if (email) {
          document.getElementById('email').textContent = email;
          document.getElementById('emailWrap').style.display = 'inline';
        }

        // Show subscription status if the function returns it
        var sub = data.subscription || data.latest_invoice || null;
        var status = '';

        if (sub && typeof sub === 'object') {
          // Some implementations return { subscription: { status: 'active' } }
          if (sub.status) status = 'Subscription: ' + String(sub.status).replace(/_/g, ' ');
        } else if (data.subscription_status) {
          status = 'Subscription: ' + String(data.subscription_status).replace(/_/g, ' ');
        }

        if (status) {
          document.getElementById('subStatus').textContent = status;
        }
      })
      .catch(err => {
        // Keep the page visible and usable even if the lookup fails
        console.log('[success] session lookup failed:', err);
      });
    })();
  </script>
</body>
</html>

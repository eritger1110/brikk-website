<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Brikk â€“ Finish account setup</title>
  <style>
    :root { color-scheme: dark; }
    body { margin:0; font:16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, sans-serif; background:#0b0f1a; color:#e7ecff; }
    .wrap { max-width:900px; margin:40px auto; padding:0 16px; }
    .panel { background:#0f1629; border:1px solid #1c2541; border-radius:16px; padding:20px; }
    h1 { font-size:28px; margin:0 0 6px; }
    .muted { color:#98b0d9 }
    .grid { display:grid; grid-template-columns:1fr 1fr; gap:16px; }
    .col { background:#0f1629; border:1px solid #1c2541; border-radius:16px; padding:18px; }
    label { display:block; font-weight:600; margin:10px 0 6px; }
    input { width:100%; background:#0B1222; border:1px solid #2a3450; color:#e7ecff; border-radius:10px; padding:.7rem .8rem; }
    input[readonly] { opacity:.8 }
    .row2 { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    button { background:#635bff; color:#fff; border:none; padding:.7rem 1.1rem; border-radius:10px; font-weight:600; cursor:pointer; }
    .error { color:#ff8d8d; margin-top:8px; min-height:20px }
    .ok { color:#7dffa3; margin-top:8px; min-height:20px }
    @media (max-width:900px) { .grid { grid-template-columns:1fr; } .row2 { grid-template-columns:1fr; } }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="panel" style="margin-bottom:16px">
      <h1>Youâ€™re all set ðŸŽ‰</h1>
      <div class="muted">Thanks for subscribing to Brikk. Weâ€™ve emailed a receipt and account details to <span id="emph-email">(your email)</span>.</div>
      <div class="muted" style="margin-top:8px">Reference: <span id="ref" style="font-family:ui-monospace"></span></div>
    </div>

    <div class="grid">
      <div class="col">
        <h3 style="margin:0 0 8px">Create your account</h3>
        <div class="muted" style="margin-bottom:12px">Finish setting your password to access your dashboard.</div>

        <div class="row2">
          <div>
            <label for="first">First name</label>
            <input id="first" autocomplete="given-name" />
          </div>
          <div>
            <label for="last">Last name</label>
            <input id="last" autocomplete="family-name" />
          </div>
        </div>

        <label for="email">Email</label>
        <input id="email" readonly />

        <label for="pw">Password</label>
        <input id="pw" type="password" autocomplete="new-password" />
        <div class="muted" style="font-size:14px;margin-top:6px">
          Minimum <strong>10</strong> chars, at least one uppercase, one lowercase, one number, one symbol.
        </div>

        <label for="pw2">Confirm password</label>
        <input id="pw2" type="password" autocomplete="new-password" />

        <div class="error" id="err"></div>
        <div class="ok" id="ok"></div>
        <button id="create">Create account</button>
      </div>

      <div class="col">
        <h3 style="margin:0 0 8px">What happens next?</h3>
        <ul class="muted" style="margin:0 0 12px 16px; padding:0 0 0 12px">
          <li>Weâ€™ll send you a verification email (valid for 24h).</li>
          <li>After creating your account youâ€™ll be signed in and taken to the dashboard.</li>
          <li>You can always manage billing from your dashboard.</li>
        </ul>
      </div>
    </div>
  </div>

<script>
const API = 'https://api.getbrikk.com';
const qs = new URLSearchParams(location.search);
const sessionId = qs.get('session_id');
const err = (m) => (document.getElementById('err').textContent = m || '');
const ok  = (m) => (document.getElementById('ok').textContent  = m || '');

let tokenFromNetlify = null;

function orderRefFromSession(id) {
  if (!id) return 'â€”';
  const tail = id.replace(/[^A-Za-z0-9]/g,'').slice(-6).toUpperCase();
  return `BRK-${tail}`;
}

async function load() {
  document.getElementById('ref').textContent = orderRefFromSession(sessionId);

  // Ask Netlify function for a short-lived token + email/name
  const r = await fetch(`/.netlify/functions/provision-link?session_id=${encodeURIComponent(sessionId)}`);
  if (!r.ok) { err('Could not initialize your session. Please refresh.'); return; }
  const out = await r.json();
  tokenFromNetlify = out.token;

  // Pre-fill fields (email read-only to avoid mismatch)
  if (out.email) document.getElementById('email').value = out.email;
  if (out.first) document.getElementById('first').value = out.first;
  if (out.last) document.getElementById('last').value  = out.last;
  document.getElementById('emph-email').textContent = out.email || '(your email)';
}

function strong(pw) {
  if (!pw || pw.length < 10) return false;
  return /[a-z]/.test(pw) && /[A-Z]/.test(pw) && /\d/.test(pw) && /[^A-Za-z0-9]/.test(pw);
}

document.getElementById('create').onclick = async () => {
  err(''); ok('');
  const first = document.getElementById('first').value.trim();
  const last  = document.getElementById('last').value.trim();
  const email = document.getElementById('email').value.trim();
  const pw    = document.getElementById('pw').value;
  const pw2   = document.getElementById('pw2').value;

  if (!tokenFromNetlify) return err('Session expired. Please refresh this page.');
  if (!first || !last)  return err('Please enter your first and last name.');
  if (!email)           return err('Email is missing.');
  if (!strong(pw))      return err('Password does not meet the requirements.');
  if (pw !== pw2)       return err('Passwords do not match.');

  try {
    const r = await fetch(`${API}/api/auth/complete-signup`, {
      method:'POST',
      credentials:'include',
      headers:{'content-type':'application/json'},
      body: JSON.stringify({ token: tokenFromNetlify, first_name:first, last_name:last, password:pw })
    });
    if (!r.ok) throw new Error(await r.text());

    ok('Account created! Redirecting to your dashboardâ€¦');
    setTimeout(() => { location.href = 'https://www.getbrikk.com/app/'; }, 800);
  } catch (e) {
    err(e.message || 'Could not reach the API.');
  }
};

load();
</script>
</body>
</html>

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Thanks â€“ Brikk</title>
  <style>
    :root { color-scheme: dark; }
    body { margin:0; font:16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, sans-serif; background:#0b0f1a; color:#e7ecff; }
    .wrap { min-height:100vh; display:grid; place-items:center; padding:32px; }
    .card { width:min(920px, 96vw); background:#0f1629; border:1px solid #1C2541; border-radius:16px; padding:32px 28px; box-shadow:0 10px 30px rgba(0,0,0,.25); }
    h1 { font-size:32px; margin:0 0 10px; }
    .muted { color:#98b0d9; }
    .row { margin-top:14px }
    .btn { display:inline-block; margin-top:18px; background:#635bff; color:white; text-decoration:none; padding:.75rem 1.25rem; border-radius:12px; font-weight:600; }
    .btn.secondary { background:#142042; }
    code { background:#0B1222; padding:.18rem .35rem; border-radius:6px; }
    #err { color:#ff8a8a; display:none; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Youâ€™re all set ðŸŽ‰</h1>
      <p class="muted" id="msg">Thanks for subscribing to Brikk. Weâ€™ve emailed a receipt and account details<span id="emailWrap" style="display:none"> to <strong id="email">â€”</strong></span>.</p>
      <p class="muted row">Session: <code id="sid">â€”</code></p>

      <div class="row">
        <a id="dash" class="btn">Go to your dashboard</a>
        <a href="/" class="btn secondary">Go to Home</a>
      </div>

      <p id="err" class="row"></p>
      <p class="muted row" id="redir" style="display:none">Redirecting you to your dashboardâ€¦</p>
    </div>
  </div>

  <script>
    // Helpers
    const qs  = new URLSearchParams(location.search);
    const sid = qs.get('session_id') || '';
    document.getElementById('sid').textContent = sid || 'â€”';

    // Always show something even if we can't fetch details
    if (!sid) {
      document.getElementById('err').style.display='block';
      document.getElementById('err').textContent = 'Missing session_id on success URL.';
    }

    // (A) Fetch email just for a nice confirmation (optional)
    if (sid) {
      fetch('/.netlify/functions/checkout-session?session_id=' + encodeURIComponent(sid))
        .then(r => r.ok ? r.json() : Promise.reject())
        .then(data => {
          const email =
            (data.customer_details && data.customer_details.email) ||
            (data.customer && data.customer.email) || '';
          if (email) {
            document.getElementById('email').textContent = email;
            document.getElementById('emailWrap').style.display = 'inline';
          }
        })
        .catch(() => {/* ignore, we still proceed */});
    }

    // (B) Get the signed welcome URL and redirect
    const dashBtn = document.getElementById('dash');

    async function getWelcomeUrl() {
      const r = await fetch('/.netlify/functions/provision-link?session_id=' + encodeURIComponent(sid));
      if (!r.ok) throw new Error(await r.text());
      const { url } = await r.json();
      if (!url) throw new Error('No URL returned from provision-link');
      return url;
    }

    async function go() {
      if (!sid) return;
      try {
        const url = await getWelcomeUrl();
        // Update button href for users who prefer to click
        dashBtn.href = url;
        // Also auto-redirect after a short delay
        document.getElementById('redir').style.display = 'block';
        setTimeout(() => { location.href = url; }, 1000);
      } catch (e) {
        document.getElementById('err').style.display='block';
        document.getElementById('err').textContent = 'Could not create dashboard link. ' +
          'Please copy your session id and contact support. Details: ' + (e.message || e);
        // Make button a safe fallback (no-token) so the page doesnâ€™t break
        dashBtn.removeAttribute('href');
      }
    }

    dashBtn.addEventListener('click', async (ev) => {
      // If we havenâ€™t filled href yet, intercept and try again
      if (!dashBtn.href || dashBtn.getAttribute('href') === '') {
        ev.preventDefault();
        await go();
      }
    });

    // Kick it off
    go();
  </script>
</body>
</html>

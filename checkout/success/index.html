<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Youâ€™re all set â€“ Brikk</title>

  <style>
    :root{
      --bg:#0b0f1a; --card:#0f1526; --border:#1f2a48; --ink:#e7ecff;
      --muted:0.85; --accent:#6a5cff; --input:#0b1020; --input-border:#233055; --danger:#ff7a7a;
    }
    *{box-sizing:border-box}
    body{background:var(--bg);color:var(--ink);font:16px/1.5 system-ui;margin:0;padding:24px}
    .container{max-width:1080px;margin:0 auto}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:20px}
    .card.hero{max-width:720px;margin:18px auto}
    h1{margin:0 0 6px;font-weight:700}
    h3{margin:0 0 8px}
    .muted{opacity:var(--muted)}
    label{display:block;font-size:14px;margin:14px 0 6px}
    input{background:var(--input);border:1px solid var(--input-border);border-radius:10px;padding:12px 14px;color:var(--ink);width:100%;min-width:0}
    button{background:var(--accent);border:none;border-radius:10px;padding:12px 16px;color:#fff;font-weight:600;cursor:pointer}
    button[disabled]{opacity:.65;cursor:not-allowed}
    .two-col{display:grid;grid-template-columns:1fr 1fr;gap:18px;margin:18px 0}
    @media (max-width:820px){.two-col{grid-template-columns:1fr}}
    .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:640px){.form-grid{grid-template-columns:1fr}}
    .error{color:var(--danger);margin-top:8px;min-height:1.2em}
    small.help{display:block;margin-top:6px;opacity:.8}
    ul{margin:8px 0 0 18px}
  </style>

  <!-- the config file in your repo lives under /public -->
  <script src="/public/config.js"></script>
</head>
<body>
  <div class="container">
    <div class="card hero">
      <h1>Youâ€™re all set ðŸŽ‰</h1>
      <p class="muted">
        Thanks for subscribing to Brikk. Weâ€™ve emailed you a <strong>receipt</strong>.
        Next, create your account below.
      </p>
      <p class="muted">Reference: <span id="ref">â€”</span></p>
    </div>

    <div class="two-col">
      <div class="card">
        <h3>Create your account</h3>
        <p class="muted">Finish setting your password to access your dashboard.</p>

        <form id="create-account-form" novalidate>
          <div class="form-grid">
            <div>
              <label for="firstName">First name</label>
              <input id="firstName" name="first_name" autocomplete="given-name" />
            </div>
            <div>
              <label for="lastName">Last name</label>
              <input id="lastName" name="last_name" autocomplete="family-name" />
            </div>
          </div>

          <label for="email">Email</label>
          <input id="email" />

          <label for="password">Password</label>
          <input id="password" name="password" type="password" autocomplete="new-password" />
          <small class="help muted">Minimum 10 chars, at least one uppercase, one lowercase, one number, one symbol.</small>

          <label for="confirm">Confirm password</label>
          <input id="confirm" type="password" autocomplete="new-password" />

          <div class="error" id="err"></div>

          <div style="margin-top:16px">
            <button id="submitBtn" type="submit">Create account</button>
          </div>
        </form>
      </div>

      <div class="card">
        <h3>What happens next?</h3>
        <ul>
          <li>After creating your account youâ€™ll be <strong>signed in automatically</strong>.</li>
          <li>Weâ€™ll send a <strong>verification email</strong> (valid for 24h) to secure your account.</li>
          <li>You can always manage billing from your dashboard.</li>
        </ul>
      </div>
    </div>
  </div>

  <script>
    const $  = (id) => document.getElementById(id);
    const q  = new URLSearchParams(location.search);
    const sessionId = q.get("session_id");
    const err = $("err");
    const btn = $("submitBtn");

    // Use config value if present; fall back to production API
    const API = ((window.__BRIKK_API__ || "https://api.getbrikk.com") + "").replace(/\/+$/, "");
    const NETLIFY_FN = "/.netlify/functions/provision-link";

    const setErr = (m) => { err.textContent = m || ""; };

    function orderRefFromSession(id){
      if (!id) return "â€”";
      const tail = id.replace(/[^A-Za-z0-9]/g,"").slice(-6).toUpperCase();
      return `BRK-${tail}`;
    }

    async function getProvision(){
      if (!sessionId) throw new Error("Missing session_id");
      const res = await fetch(`${NETLIFY_FN}?session_id=${encodeURIComponent(sessionId)}`, { credentials:"include" });
      if (!res.ok) throw new Error(`Provision error ${res.status}`);
      return res.json();
    }

    function strong(pw){
      return !!pw && pw.length >= 10 && /[a-z]/.test(pw) && /[A-Z]/.test(pw) && /\d/.test(pw) && /[^A-Za-z0-9]/.test(pw);
    }

    async function createAccount(token){
      const first = $("firstName").value.trim();
      const last  = $("lastName").value.trim();
      const pw    = $("password").value;
      const pw2   = $("confirm").value;

      if (!first || !last)   throw new Error("Please enter your first and last name.");
      if (!strong(pw))       throw new Error("Password does not meet the requirements.");
      if (pw !== pw2)        throw new Error("Passwords do not match.");

      // We rely on the token's email server-side; no need to send the email value from the form
      const payload = { token, first_name:first, last_name:last, password:pw };

      const r = await fetch(`${API}/api/auth/complete-signup`, {
        method:"POST",
        headers:{ "content-type":"application/json" },
        credentials:"include",
        body: JSON.stringify(payload)
      });

      let data = null; try { data = await r.json(); } catch(_) {}

      if (!r.ok) throw new Error((data && (data.error || data.message)) || `API ${r.status}`);

      // Success â†’ cookie is set; go to dashboard
      location.assign("/app");
    }

    (async () => {
      $("ref").textContent = orderRefFromSession(sessionId);

      try {
        const prov = await getProvision();

        // Pre-fill from Netlify function
        $("firstName").value = prov.first || "";
        $("lastName").value  = prov.last  || "";
        $("email").value     = prov.email || "";

        // Make email read-only only if we actually have it from Stripe
        if (prov.email) $("email").readOnly = true;

        // Attach submit
        $("create-account-form").addEventListener("submit", async (e) => {
          e.preventDefault();
          setErr(""); btn.disabled = true;
          try {
            await createAccount(prov.token);
          } catch (e) {
            setErr(e?.message || "Failed to create account.");
            btn.disabled = false;
          }
        });
      } catch (e) {
        setErr(e?.message || "Could not initialize your session. Please refresh this page.");
      }
    })();
  </script>
</body>
</html>

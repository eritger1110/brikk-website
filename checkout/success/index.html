<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Thanks â€“ Brikk</title>
  <style>
    :root { color-scheme: dark; }
    body { margin:0; font:16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, sans-serif; background:#0b0f1a; color:#e7ecff; }
    .wrap { min-height:100vh; display:grid; place-items:center; padding:32px; }
    .card { width:min(920px, 96vw); background:#0f1629; border:1px solid #1C2541; border-radius:16px; padding:32px 28px; box-shadow:0 10px 30px rgba(0,0,0,.25); }
    h1 { font-size:32px; margin:0 0 10px; }
    .muted { color:#98b0d9; }
    .btn { display:inline-block; margin-top:18px; background:#635bff; color:#fff; text-decoration:none; padding:.75rem 1.25rem; border-radius:12px; font-weight:600; }
    .btn.secondary { background:#0B1222; border:1px solid #2a3450; margin-left:8px; }
    code { background:#0B1222; padding:.12rem .35rem; border-radius:6px; }
    .row { margin-top:12px }
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Youâ€™re all set ðŸŽ‰</h1>
    <p id="msg">Thanks for subscribing to Brikk. Weâ€™ve emailed a receipt and account details<span id="emailWrap" class="muted" style="display:none"> to <strong id="email"></strong></span>.</p>

    <div class="row muted">Session: <code id="sid">â€”</code></div>

    <div class="row">
      <a id="dashBtn" class="btn" href="/">Go to your dashboard</a>
      <a class="btn secondary" href="/">Go to Home</a>
    </div>
  </div>
</div>

<script>
(function () {
  const qs = new URLSearchParams(location.search);
  const sid = qs.get('session_id') || '';
  document.getElementById('sid').textContent = sid || 'â€”';

  if (!sid) return; // Show static success if we canâ€™t identify the session

  // 1) Ask Netlify to mint a short-lived link and give us the redirect URL
  fetch('/.netlify/functions/provision-link?session_id=' + encodeURIComponent(sid))
    .then(r => r.ok ? r.json() : Promise.reject())
    .then(data => {
      if (data && data.redirect) {
        const btn = document.getElementById('dashBtn');
        btn.href = data.redirect;
        btn.textContent = 'Go to your dashboard';
        // auto-redirect shortly
        setTimeout(() => { window.location.href = data.redirect; }, 1200);
      }
    })
    .catch(() => {
      // keep graceful fallback (the Home button works)
    });

  // 2) (Optional) Show the email from the session, if you kept checkout-session.ts
  fetch('/.netlify/functions/checkout-session?session_id=' + encodeURIComponent(sid))
    .then(r => r.ok ? r.json() : Promise.reject())
    .then(data => {
      const email =
        (data.customer_details && data.customer_details.email) ||
        (data.customer && data.customer.email) || '';
      if (email) {
        document.getElementById('email').textContent = email;
        document.getElementById('emailWrap').style.display = 'inline';
      }
    })
    .catch(() => {});
})();
</script>
</body>
</html>

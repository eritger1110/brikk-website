<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Youâ€™re all set â€“ Brikk</title>

  <style>
    :root{
      --bg: #0b0f1a;
      --card: #0f1526;
      --border: #1f2a48;
      --ink: #e7ecff;
      --muted: 0.85;
      --accent: #6a5cff;
      --input: #0b1020;
      --input-border: #233055;
      --danger: #ff7a7a;
    }
    *{box-sizing:border-box}
    body{background:var(--bg);color:var(--ink);font:16px/1.5 system-ui;margin:0;padding:24px}
    .container{max-width:1080px;margin:0 auto}

    /* Card */
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:16px;
      padding:20px;
    }
    /* Only the hero card is constrained */
    .card.hero{max-width:720px;margin:18px auto}

    h1{margin:0 0 6px;font-weight:700}
    h3{margin:0 0 8px}
    .muted{opacity:var(--muted)}
    label{display:block;font-size:14px;margin:14px 0 6px}

    input{
      background:var(--input);
      border:1px solid var(--input-border);
      border-radius:10px;
      padding:12px 14px;
      color:var(--ink);
      width:100%;
      min-width:0;
    }

    button{
      background:var(--accent);
      border:none;border-radius:10px;
      padding:12px 16px;
      color:#fff;font-weight:600;
      cursor:pointer;
    }
    button[disabled]{opacity:.65;cursor:not-allowed}

    /* Two-column layout that won't overflow */
    .two-col{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:18px;
      margin:18px 0;
    }
    @media (max-width: 820px){
      .two-col{grid-template-columns:1fr}
    }

    /* Form grid for first/last name */
    .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:640px){.form-grid{grid-template-columns:1fr}}

    .error{color:var(--danger);margin-top:8px}
    small.help{display:block;margin-top:6px;opacity:.8}
    ul{margin:8px 0 0 18px}
  </style>

  <!-- Exposes window.__BRIKK_API__ = "https://api.getbrikk.com" -->
  <script src="/config.js"></script>
</head>
<body>
  <div class="container">
    <!-- Hero -->
    <div class="card hero">
      <h1>Youâ€™re all set ðŸŽ‰</h1>
      <p class="muted">
        Thanks for subscribing to Brikk. Weâ€™ve emailed you a <strong>receipt</strong>.
        Next, create your account below.
      </p>
      <p class="muted">Reference: <span id="ref">â€”</span></p>
    </div>

    <!-- Main content -->
    <div class="two-col">
      <!-- Left: account form -->
      <div class="card">
        <h3>Create your account</h3>
        <p class="muted">Finish setting your password to access your dashboard.</p>

        <form id="create-account-form" novalidate>
          <div class="form-grid">
            <div>
              <label for="firstName">First name</label>
              <input id="firstName" name="first_name" autocomplete="given-name" />
            </div>
            <div>
              <label for="lastName">Last name</label>
              <input id="lastName" name="last_name" autocomplete="family-name" />
            </div>
          </div>

          <label for="email">Email</label>
          <input id="email" name="email" type="email" autocomplete="email" />

          <label for="password">Password</label>
          <input id="password" name="password" type="password" autocomplete="new-password" />
          <small class="help muted">
            Minimum 10 chars, at least one uppercase, one lowercase, one number, one symbol.
          </small>

          <label for="confirm">Confirm password</label>
          <input id="confirm" type="password" autocomplete="new-password" />

          <div class="error" id="err" hidden></div>

          <div style="margin-top:16px">
            <button id="submitBtn" type="submit">Create account</button>
          </div>
        </form>
      </div>

      <!-- Right: what happens next -->
      <div class="card">
        <h3>What happens next?</h3>
        <ul>
          <li>After creating your account youâ€™ll be <strong>signed in automatically</strong>.</li>
          <li>Weâ€™ll send a <strong>verification email</strong> (valid for 24h) to secure your account.</li>
          <li>You can always manage billing from your dashboard.</li>
        </ul>
      </div>
    </div>
  </div>

  <script>
    // Helpers
    const $ = (id) => document.getElementById(id);
    const q = new URLSearchParams(location.search);
    const sessionId = q.get("session_id");
    const err = $("err");
    const btn = $("submitBtn");

    // API base from /public/config.js (fallback kept just in case)
    const API = (window.__BRIKK_API__ || (import.meta?.env?.VITE_API_URL || "")).replace(/\/+$/, "") ||
                "https://brikk-infrastructure.onrender.com";

    // Netlify function that returns { token, first, last, email, reference }
    const NETLIFY_FN = "/.netlify/functions/provision-link";

    function showError(msg){
      err.textContent = msg || "Something went wrong. Please try again.";
      err.hidden = false;
    }

    async function getProvision() {
      if (!sessionId) throw new Error("Missing session_id");
      const res = await fetch(`${NETLIFY_FN}?session_id=${encodeURIComponent(sessionId)}`, {
        credentials: "include"
      });
      if (!res.ok) throw new Error(`Provision error ${res.status}`);
      return res.json();
    }

    async function createAccount({ token }) {
      const pw = $("password").value;
      const cf = $("confirm").value;
      if (pw.length < 10) throw new Error("Password does not meet requirements");
      if (pw !== cf) throw new Error("Passwords do not match");

      const payload = {
        token,
        first_name: $("firstName").value.trim(),
        last_name:  $("lastName").value.trim(),
        email:      $("email").value.trim().toLowerCase(),
        password:   pw
      };

      const res = await fetch(`${API}/auth/complete-signup`, {
        method: "POST",
        headers: { "content-type": "application/json" },
        credentials: "include",         // <-- critical so the Set-Cookie is stored
        body: JSON.stringify(payload)
      });

      // Try to read error details if any
      let data = null;
      try { data = await res.json(); } catch(_) {}

      if (!res.ok) {
        throw new Error((data && data.error) || `API ${res.status} ${res.statusText}`);
      }

      // Cookie issued â†’ go to the dashboard route on the same site
      location.assign("/app");
    }

    (async () => {
      try {
        const prov = await getProvision();

        // Fill UI
        $("ref").textContent = prov.reference || "â€”";
        $("firstName").value = prov.first || "";
        $("lastName").value  = prov.last  || "";
        $("email").value     = prov.email || "";

        // Hook submit
        $("create-account-form").addEventListener("submit", async (e) => {
          e.preventDefault();
          err.hidden = true;
          btn.disabled = true;
          try {
            await createAccount(prov);
          } catch (e) {
            showError(e?.message || "Failed to create account. Please try again.");
            btn.disabled = false;
          }
        });
      } catch (e) {
        showError(e?.message || "Failed to fetch");
      }
    })();
  </script>
</body>
</html>
